name: Build pysqlite3 (SQLite WAL2) wheels — enforce all compile options

on:
  workflow_dispatch:
  push:
    tags: ["wheels-*"]

env:
  # Choose which SQLite branch to build:
  # - "wal2" (default) tracks WAL2 tip. For determinism, pin to a wal2-* sub-branch or a specific SHA.
  # - "trunk" if you don't want WAL2.
  SQLITE_WAL2_BRANCH: "wal2"

  # POSIX-style defines (used in env, and also injected via defines.h to make flags deterministic)
  POSIX_SQLITE_DEFINES: >-
    -DSQLITE_ENABLE_JSON1=1
    -DSQLITE_ENABLE_FTS5=1
    -DSQLITE_ENABLE_RTREE=1
    -DSQLITE_ENABLE_STAT4=1
    -DSQLITE_ENABLE_MATH_FUNCTIONS=1
    -DSQLITE_ENABLE_NORMALIZE=1
    -DSQLITE_ENABLE_DESERIALIZE=1
    -DSQLITE_ENABLE_DBPAGE_VTAB=1
    -DSQLITE_ENABLE_DBSTAT_VTAB=1
    -DSQLITE_ENABLE_STMTVTAB=1
    -DSQLITE_ENABLE_COLUMN_METADATA=1
    -DSQLITE_LIKE_DOESNT_MATCH_BLOBS=1
    -DSQLITE_DEFAULT_MEMSTATUS=0
    -DSQLITE_THREADSAFE=2
    -DSQLITE_OMIT_DEPRECATED=1
    -DSQLITE_ENABLE_NAN_INF=1

  PYSQLITE3_VERSION: "0.5.4"

jobs:
  prep-sqlite-amalgamation:
    name: Prepare SQLite WAL2 amalgamation (cached by SHA)
    runs-on: ubuntu-latest
    steps:
      - name: Install prerequisites
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y fossil tcl build-essential

      - name: Resolve WAL2 SHA
        id: wal2
        run: |
          set -euxo pipefail
          mkdir sqlite-src && cd sqlite-src
          fossil clone https://sqlite.org/src sqlite.fossil
          mkdir repo && cd repo
          fossil open ../sqlite.fossil
          fossil update "${SQLITE_WAL2_BRANCH}"
          WAL2_SHA=$(fossil info | awk '/^checkout:/ {print $2}')
          echo "sha=$WAL2_SHA" >> "$GITHUB_OUTPUT"

      - name: Restore amalgamation cache
        id: cache-amalg
        uses: actions/cache@v4
        with:
          path: sqlite-src/out
          key: sqlite-wal2-${{ steps.wal2.outputs.sha }}

      - name: Configure & build amalgamation (sqlite3.c / sqlite3.h)
        if: steps.cache-amalg.outputs.cache-hit != 'true'
        run: |
          set -euxo pipefail
          cd sqlite-src/repo
          fossil update "${{ steps.wal2.outputs.sha }}"
          ./configure
          make sqlite3.c sqlite3.h
          cp tsrc/sqlite3ext.h . || cp src/sqlite3ext.h .
          mkdir -p ../out
          cp sqlite3.c sqlite3.h sqlite3ext.h ../out/
          echo "${{ steps.wal2.outputs.sha }}" > ../out/WAL2_SHA.txt

      - name: Upload amalgamation artifact (incl. pinned SHA)
        uses: actions/upload-artifact@v4
        with:
          name: sqlite-wal2-amalgamation
          path: sqlite-src/out/*

  # ---------- Helpers reused in post-build checks ----------
  # Python snippet used by all build jobs to assert compile options & do quick functional probes.
  # (Duplicated in each job via here-doc for simplicity/portability.)
  # It tolerates options rendered as NAME=VALUE (e.g., THREADSAFE=2).
  # The script exits nonzero if any required option is missing.
  # Required options include: FTS5, RTREE, STAT4, MATH_FUNCTIONS, NORMALIZE, COLUMN_METADATA,
  # DBPAGE_VTAB, DBSTAT_VTAB, STMTVTAB, LIKE_DOESNT_MATCH_BLOBS, DEFAULT_MEMSTATUS, THREADSAFE, OMIT_DEPRECATED, ENABLE_NAN_INF.

  # ---------- Linux manylinux ----------
  linux-manylinux-x86_64:
    name: Linux manylinux wheels (cp39–cp312, x86_64)
    needs: prep-sqlite-amalgamation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/setup.cfg') }}

      - uses: actions/cache@v4
        with:
          path: ~/.cache/cibuildwheel
          key: cibw-${{ runner.os }}

      - uses: actions/download-artifact@v4
        with:
          name: sqlite-wal2-amalgamation
          path: amalgamation

      - name: Clone pysqlite3 and vendor amalgamation (+prepend defines.h)
        run: |
          set -euxo pipefail
          git clone --depth 1 --branch "${PYSQLITE3_VERSION}" https://github.com/coleifer/pysqlite3.git pysqlite3-src
          cp amalgamation/sqlite3.c pysqlite3-src/
          cp amalgamation/sqlite3.h pysqlite3-src/
          cp amalgamation/sqlite3ext.h pysqlite3-src/
          cat > pysqlite3-src/defines.h <<'EOF'
          #define SQLITE_ENABLE_JSON1 1
          #define SQLITE_ENABLE_FTS5 1
          #define SQLITE_ENABLE_RTREE 1
          #define SQLITE_ENABLE_STAT4 1
          #define SQLITE_ENABLE_MATH_FUNCTIONS 1
          #define SQLITE_ENABLE_NORMALIZE 1
          #define SQLITE_ENABLE_DESERIALIZE 1
          #define SQLITE_ENABLE_DBPAGE_VTAB 1
          #define SQLITE_ENABLE_DBSTAT_VTAB 1
          #define SQLITE_ENABLE_STMTVTAB 1
          #define SQLITE_ENABLE_COLUMN_METADATA 1
          #define SQLITE_LIKE_DOESNT_MATCH_BLOBS 1
          #define SQLITE_DEFAULT_MEMSTATUS 0
          #define SQLITE_THREADSAFE 2
          #define SQLITE_OMIT_DEPRECATED 1
          #define SQLITE_ENABLE_NAN_INF 1
          EOF
          { printf '#include "defines.h"\n'; cat pysqlite3-src/sqlite3.c; } > pysqlite3-src/sqlite3.c.new
          mv pysqlite3-src/sqlite3.c.new pysqlite3-src/sqlite3.c
          head -n 1 pysqlite3-src/sqlite3.c | grep -q 'defines.h'

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - run: python -m pip install -U pip cibuildwheel==2.*

      - name: Build wheels
        env:
          CIBW_BUILD: "cp39-manylinux_* cp310-manylinux_* cp311-manylinux_* cp312-manylinux_*"
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_BEFORE_BUILD: "python -m pip install -U setuptools wheel && cd {package} && python setup.py build_static"
          # Make env flags stick for all tool invocations:
          CIBW_ENVIRONMENT_LINUX: 'CFLAGS="-O3 -fPIC -DNDEBUG ${{ env.POSIX_SQLITE_DEFINES }}" CPPFLAGS="$CFLAGS"'
          CIBW_BUILD_VERBOSITY: "1"
        run: python -m cibuildwheel pysqlite3-src --output-dir wheelhouse

      - name: Verify compile options + quick probes
        run: |
          set -euxo pipefail
          python -m pip install --no-index --find-links=wheelhouse "pysqlite3==${PYSQLITE3_VERSION}"
          python - <<'PY'
import pysqlite3.dbapi2 as sqlite3, sys, os, tempfile
con = sqlite3.connect(":memory:")
opts = {row[0] for row in con.execute("pragma compile_options")}
def present(name): return any(o==name or o.startswith(name+'=') for o in opts)
want = [
  "ENABLE_FTS5","ENABLE_RTREE","ENABLE_STAT4","ENABLE_MATH_FUNCTIONS",
  "ENABLE_NORMALIZE","ENABLE_COLUMN_METADATA","ENABLE_DBPAGE_VTAB",
  "ENABLE_DBSTAT_VTAB","ENABLE_STMTVTAB","LIKE_DOESNT_MATCH_BLOBS",
  "DEFAULT_MEMSTATUS","THREADSAFE","OMIT_DEPRECATED","ENABLE_NAN_INF"
]
missing = [w for w in want if not present(w)]
# functional probes for a few features:
con.execute("CREATE VIRTUAL TABLE f USING fts5(x);")
con.execute("CREATE VIRTUAL TABLE r USING rtree(id,minX,maxX,minY,maxY);")
con.execute("SELECT sin(0.0), log(10.0);").fetchone()
# WAL2 probe (file-backed)
with tempfile.TemporaryDirectory() as d:
    db = os.path.join(d,"t.db")
    c = sqlite3.connect(db)
    jm = c.execute("PRAGMA journal_mode=wal2;").fetchone()[0]
    c.close()
    wal2_ok = (jm == "wal2")
print("Missing options:", missing)
sys.exit(1 if missing or not wal2_ok else 0)
PY

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-manylinux-x86_64
          path: wheelhouse/*.whl

  linux-manylinux-aarch64:
    name: Linux manylinux wheels (cp39–cp312, aarch64 • native)
    needs: prep-sqlite-amalgamation
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/setup.cfg') }}
      - uses: actions/cache@v4
        with:
          path: ~/.cache/cibuildwheel
          key: cibw-${{ runner.os }}
      - uses: actions/download-artifact@v4
        with:
          name: sqlite-wal2-amalgamation
          path: amalgamation
      - name: Clone pysqlite3 and vendor amalgamation (+prepend defines.h)
        run: |
          set -euxo pipefail
          git clone --depth 1 --branch "${PYSQLITE3_VERSION}" https://github.com/coleifer/pysqlite3.git pysqlite3-src
          cp amalgamation/sqlite3.c pysqlite3-src/
          cp amalgamation/sqlite3.h pysqlite3-src/
          cp amalgamation/sqlite3ext.h pysqlite3-src/
          cat > pysqlite3-src/defines.h <<'EOF'
          #define SQLITE_ENABLE_JSON1 1
          #define SQLITE_ENABLE_FTS5 1
          #define SQLITE_ENABLE_RTREE 1
          #define SQLITE_ENABLE_STAT4 1
          #define SQLITE_ENABLE_MATH_FUNCTIONS 1
          #define SQLITE_ENABLE_NORMALIZE 1
          #define SQLITE_ENABLE_DESERIALIZE 1
          #define SQLITE_ENABLE_DBPAGE_VTAB 1
          #define SQLITE_ENABLE_DBSTAT_VTAB 1
          #define SQLITE_ENABLE_STMTVTAB 1
          #define SQLITE_ENABLE_COLUMN_METADATA 1
          #define SQLITE_LIKE_DOESNT_MATCH_BLOBS 1
          #define SQLITE_DEFAULT_MEMSTATUS 0
          #define SQLITE_THREADSAFE 2
          #define SQLITE_OMIT_DEPRECATED 1
          #define SQLITE_ENABLE_NAN_INF 1
          EOF
          { printf '#include "defines.h"\n'; cat pysqlite3-src/sqlite3.c; } > pysqlite3-src/sqlite3.c.new
          mv pysqlite3-src/sqlite3.c.new pysqlite3-src/sqlite3.c
          head -n 1 pysqlite3-src/sqlite3.c | grep -q 'defines.h'
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: python -m pip install -U pip cibuildwheel==2.*
      - name: Build wheels (native arm64)
        env:
          CIBW_BUILD: "cp39-manylinux_* cp310-manylinux_* cp311-manylinux_* cp312-manylinux_*"
          CIBW_ARCHS_LINUX: "aarch64"
          CIBW_BEFORE_BUILD: "python -m pip install -U setuptools wheel && cd {package} && python setup.py build_static"
          CIBW_ENVIRONMENT_LINUX: 'CFLAGS="-O3 -fPIC -DNDEBUG ${{ env.POSIX_SQLITE_DEFINES }}" CPPFLAGS="$CFLAGS"'
          CIBW_BUILD_VERBOSITY: "1"
        run: python -m cibuildwheel pysqlite3-src --output-dir wheelhouse
      - name: Verify compile options + quick probes
        run: |
          set -euxo pipefail
          python -m pip install --no-index --find-links=wheelhouse "pysqlite3==${PYSQLITE3_VERSION}"
          python - <<'PY'
import pysqlite3.dbapi2 as sqlite3, sys, os, tempfile
con = sqlite3.connect(":memory:")
opts = {row[0] for row in con.execute("pragma compile_options")}
def present(name): return any(o==name or o.startswith(name+'=') for o in opts)
want = ["ENABLE_FTS5","ENABLE_RTREE","ENABLE_STAT4","ENABLE_MATH_FUNCTIONS","ENABLE_NORMALIZE","ENABLE_COLUMN_METADATA","ENABLE_DBPAGE_VTAB","ENABLE_DBSTAT_VTAB","ENABLE_STMTVTAB","LIKE_DOESNT_MATCH_BLOBS","DEFAULT_MEMSTATUS","THREADSAFE","OMIT_DEPRECATED","ENABLE_NAN_INF"]
missing = [w for w in want if not present(w)]
con.execute("CREATE VIRTUAL TABLE f USING fts5(x);")
con.execute("CREATE VIRTUAL TABLE r USING rtree(id,minX,maxX,minY,maxY);")
con.execute("SELECT sin(0.0), log(10.0);").fetchone()
with tempfile.TemporaryDirectory() as d:
    db = os.path.join(d,"t.db")
    c = sqlite3.connect(db)
    jm = c.execute("PRAGMA journal_mode=wal2;").fetchone()[0]
    c.close()
    wal2_ok = (jm == "wal2")
print("Missing options:", missing)
sys.exit(1 if missing or not wal2_ok else 0)
PY
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-manylinux-aarch64
          path: wheelhouse/*.whl

  # ---------- Linux musllinux ----------
  linux-musllinux-x86_64:
    name: Linux musllinux wheels (cp39–cp312, x86_64)
    needs: prep-sqlite-amalgamation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/setup.cfg') }}
      - uses: actions/cache@v4
        with:
          path: ~/.cache/cibuildwheel
          key: cibw-${{ runner.os }}
      - uses: actions/download-artifact@v4
        with:
          name: sqlite-wal2-amalgamation
          path: amalgamation
      - name: Clone pysqlite3 and vendor amalgamation (+prepend defines.h)
        run: |
          set -euxo pipefail
          git clone --depth 1 --branch "${PYSQLITE3_VERSION}" https://github.com/coleifer/pysqlite3.git pysqlite3-src
          cp amalgamation/sqlite3.c pysqlite3-src/
          cp amalgamation/sqlite3.h pysqlite3-src/
          cp amalgamation/sqlite3ext.h pysqlite3-src/
          cat > pysqlite3-src/defines.h <<'EOF'
          #define SQLITE_ENABLE_JSON1 1
          #define SQLITE_ENABLE_FTS5 1
          #define SQLITE_ENABLE_RTREE 1
          #define SQLITE_ENABLE_STAT4 1
          #define SQLITE_ENABLE_MATH_FUNCTIONS 1
          #define SQLITE_ENABLE_NORMALIZE 1
          #define SQLITE_ENABLE_DESERIALIZE 1
          #define SQLITE_ENABLE_DBPAGE_VTAB 1
          #define SQLITE_ENABLE_DBSTAT_VTAB 1
          #define SQLITE_ENABLE_STMTVTAB 1
          #define SQLITE_ENABLE_COLUMN_METADATA 1
          #define SQLITE_LIKE_DOESNT_MATCH_BLOBS 1
          #define SQLITE_DEFAULT_MEMSTATUS 0
          #define SQLITE_THREADSAFE 2
          #define SQLITE_OMIT_DEPRECATED 1
          #define SQLITE_ENABLE_NAN_INF 1
          EOF
          { printf '#include "defines.h"\n'; cat pysqlite3-src/sqlite3.c; } > pysqlite3-src/sqlite3.c.new
          mv pysqlite3-src/sqlite3.c.new pysqlite3-src/sqlite3.c
          head -n 1 pysqlite3-src/sqlite3.c | grep -q 'defines.h'
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: python -m pip install -U pip cibuildwheel==2.*
      - name: Build wheels
        env:
          CIBW_BUILD: "cp39-musllinux_* cp310-musllinux_* cp311-musllinux_* cp312-musllinux_*"
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_BEFORE_BUILD: "python -m pip install -U setuptools wheel && cd {package} && python setup.py build_static"
          CIBW_ENVIRONMENT_LINUX: 'CFLAGS="-O3 -fPIC -DNDEBUG ${{ env.POSIX_SQLITE_DEFINES }}" CPPFLAGS="$CFLAGS"'
          CIBW_BUILD_VERBOSITY: "1"
        run: python -m cibuildwheel pysqlite3-src --output-dir wheelhouse
      - name: Verify compile options + quick probes
        run: |
          set -euxo pipefail
          python -m pip install --no-index --find-links=wheelhouse "pysqlite3==${PYSQLITE3_VERSION}"
          python - <<'PY'
import pysqlite3.dbapi2 as sqlite3, sys, os, tempfile
con = sqlite3.connect(":memory:")
opts = {row[0] for row in con.execute("pragma compile_options")}
def present(name): return any(o==name or o.startswith(name+'=') for o in opts)
want = ["ENABLE_FTS5","ENABLE_RTREE","ENABLE_STAT4","ENABLE_MATH_FUNCTIONS","ENABLE_NORMALIZE","ENABLE_COLUMN_METADATA","ENABLE_DBPAGE_VTAB","ENABLE_DBSTAT_VTAB","ENABLE_STMTVTAB","LIKE_DOESNT_MATCH_BLOBS","DEFAULT_MEMSTATUS","THREADSAFE","OMIT_DEPRECATED","ENABLE_NAN_INF"]
missing = [w for w in want if not present(w)]
con.execute("CREATE VIRTUAL TABLE f USING fts5(x);")
con.execute("CREATE VIRTUAL TABLE r USING rtree(id,minX,maxX,minY,maxY);")
con.execute("SELECT sin(0.0), log(10.0);").fetchone()
with tempfile.TemporaryDirectory() as d:
    db = os.path.join(d,"t.db")
    c = sqlite3.connect(db)
    jm = c.execute("PRAGMA journal_mode=wal2;").fetchone()[0]
    c.close()
    wal2_ok = (jm == "wal2")
print("Missing options:", missing)
sys.exit(1 if missing or not wal2_ok else 0)
PY
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-musllinux-x86_64
          path: wheelhouse/*.whl

  linux-musllinux-aarch64:
    name: Linux musllinux wheels (cp39–cp312, aarch64 • native)
    needs: prep-sqlite-amalgamation
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/setup.cfg') }}
      - uses: actions/cache@v4
        with:
          path: ~/.cache/cibuildwheel
          key: cibw-${{ runner.os }}
      - uses: actions/download-artifact@v4
        with:
          name: sqlite-wal2-amalgamation
          path: amalgamation
      - name: Clone pysqlite3 and vendor amalgamation (+prepend defines.h)
        run: |
          set -euxo pipefail
          git clone --depth 1 --branch "${PYSQLITE3_VERSION}" https://github.com/coleifer/pysqlite3.git pysqlite3-src
          cp amalgamation/sqlite3.c pysqlite3-src/
          cp amalgamation/sqlite3.h pysqlite3-src/
          cp amalgamation/sqlite3ext.h pysqlite3-src/
          cat > pysqlite3-src/defines.h <<'EOF'
          #define SQLITE_ENABLE_JSON1 1
          #define SQLITE_ENABLE_FTS5 1
          #define SQLITE_ENABLE_RTREE 1
          #define SQLITE_ENABLE_STAT4 1
          #define SQLITE_ENABLE_MATH_FUNCTIONS 1
          #define SQLITE_ENABLE_NORMALIZE 1
          #define SQLITE_ENABLE_DESERIALIZE 1
          #define SQLITE_ENABLE_DBPAGE_VTAB 1
          #define SQLITE_ENABLE_DBSTAT_VTAB 1
          #define SQLITE_ENABLE_STMTVTAB 1
          #define SQLITE_ENABLE_COLUMN_METADATA 1
          #define SQLITE_LIKE_DOESNT_MATCH_BLOBS 1
          #define SQLITE_DEFAULT_MEMSTATUS 0
          #define SQLITE_THREADSAFE 2
          #define SQLITE_OMIT_DEPRECATED 1
          #define SQLITE_ENABLE_NAN_INF 1
          EOF
          { printf '#include "defines.h"\n'; cat pysqlite3-src/sqlite3.c; } > pysqlite3-src/sqlite3.c.new
          mv pysqlite3-src/sqlite3.c.new pysqlite3-src/sqlite3.c
          head -n 1 pysqlite3-src/sqlite3.c | grep -q 'defines.h'
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: python -m pip install -U pip cibuildwheel==2.*
      - name: Build wheels (native arm64)
        env:
          CIBW_BUILD: "cp39-musllinux_* cp310-musllinux_* cp311-musllinux_* cp312-musllinux_*"
          CIBW_ARCHS_LINUX: "aarch64"
          CIBW_BEFORE_BUILD: "python -m pip install -U setuptools wheel && cd {package} && python setup.py build_static"
          CIBW_ENVIRONMENT_LINUX: 'CFLAGS="-O3 -fPIC -DNDEBUG ${{ env.POSIX_SQLITE_DEFINES }}" CPPFLAGS="$CFLAGS"'
          CIBW_BUILD_VERBOSITY: "1"
        run: python -m cibuildwheel pysqlite3-src --output-dir wheelhouse
      - name: Verify compile options + quick probes
        run: |
          set -euxo pipefail
          python -m pip install --no-index --find-links=wheelhouse "pysqlite3==${PYSQLITE3_VERSION}"
          python - <<'PY'
import pysqlite3.dbapi2 as sqlite3, sys, os, tempfile
con = sqlite3.connect(":memory:")
opts = {row[0] for row in con.execute("pragma compile_options")}
def present(name): return any(o==name or o.startswith(name+'=') for o in opts)
want = ["ENABLE_FTS5","ENABLE_RTREE","ENABLE_STAT4","ENABLE_MATH_FUNCTIONS","ENABLE_NORMALIZE","ENABLE_COLUMN_METADATA","ENABLE_DBPAGE_VTAB","ENABLE_DBSTAT_VTAB","ENABLE_STMTVTAB","LIKE_DOESNT_MATCH_BLOBS","DEFAULT_MEMSTATUS","THREADSAFE","OMIT_DEPRECATED","ENABLE_NAN_INF"]
missing = [w for w in want if not present(w)]
con.execute("CREATE VIRTUAL TABLE f USING fts5(x);")
con.execute("CREATE VIRTUAL TABLE r USING rtree(id,minX,maxX,minY,maxY);")
con.execute("SELECT sin(0.0), log(10.0);").fetchone()
with tempfile.TemporaryDirectory() as d:
    db = os.path.join(d,"t.db")
    c = sqlite3.connect(db)
    jm = c.execute("PRAGMA journal_mode=wal2;").fetchone()[0]
    c.close()
    wal2_ok = (jm == "wal2")
print("Missing options:", missing)
sys.exit(1 if missing or not wal2_ok else 0)
PY
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-musllinux-aarch64
          path: wheelhouse/*.whl

  # ---------- macOS ----------
  macos-x86_64:
    name: macOS x86_64 wheels (cp39–cp312)
    needs: prep-sqlite-amalgamation
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: sqlite-wal2-amalgamation
          path: amalgamation
      - name: Clone pysqlite3 and vendor amalgamation (+prepend defines.h)
        run: |
          set -euxo pipefail
          git clone --depth 1 --branch "${PYSQLITE3_VERSION}" https://github.com/coleifer/pysqlite3.git pysqlite3-src
          cp amalgamation/sqlite3.c pysqlite3-src/
          cp amalgamation/sqlite3.h pysqlite3-src/
          cp amalgamation/sqlite3ext.h pysqlite3-src/
          (cat <<'EOF'
          #define SQLITE_ENABLE_JSON1 1
          #define SQLITE_ENABLE_FTS5 1
          #define SQLITE_ENABLE_RTREE 1
          #define SQLITE_ENABLE_STAT4 1
          #define SQLITE_ENABLE_MATH_FUNCTIONS 1
          #define SQLITE_ENABLE_NORMALIZE 1
          #define SQLITE_ENABLE_DESERIALIZE 1
          #define SQLITE_ENABLE_DBPAGE_VTAB 1
          #define SQLITE_ENABLE_DBSTAT_VTAB 1
          #define SQLITE_ENABLE_STMTVTAB 1
          #define SQLITE_ENABLE_COLUMN_METADATA 1
          #define SQLITE_LIKE_DOESNT_MATCH_BLOBS 1
          #define SQLITE_DEFAULT_MEMSTATUS 0
          #define SQLITE_THREADSAFE 2
          #define SQLITE_OMIT_DEPRECATED 1
          #define SQLITE_ENABLE_NAN_INF 1
          EOF
          ) > pysqlite3-src/defines.h
          (printf '#include "defines.h"\n'; cat pysqlite3-src/sqlite3.c) > pysqlite3-src/sqlite3.c.new
          mv pysqlite3-src/sqlite3.c.new pysqlite3-src/sqlite3.c
          head -n 1 pysqlite3-src/sqlite3.c | grep -q 'defines.h'
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: python -m pip install -U pip cibuildwheel==2.*
      - name: Build wheels
        env:
          CIBW_BUILD: "cp39-macosx_* cp310-macosx_* cp311-macosx_* cp312-macosx_*"
          CIBW_ARCHS_MACOS: "x86_64"
          CIBW_BEFORE_BUILD: "python -m pip install -U setuptools wheel && cd {package} && python setup.py build_static"
          CIBW_ENVIRONMENT_MACOS: 'MACOSX_DEPLOYMENT_TARGET=10.9 CFLAGS="-O3 -fPIC -DNDEBUG ${{ env.POSIX_SQLITE_DEFINES }}" CPPFLAGS="$CFLAGS"'
          CIBW_BUILD_VERBOSITY: "1"
        run: python -m cibuildwheel pysqlite3-src --output-dir wheelhouse
      - name: Verify compile options + quick probes
        run: |
          set -euxo pipefail
          python -m pip install --no-index --find-links=wheelhouse "pysqlite3==${PYSQLITE3_VERSION}"
          python - <<'PY'
import pysqlite3.dbapi2 as sqlite3, sys, os, tempfile
con = sqlite3.connect(":memory:")
opts = {row[0] for row in con.execute("pragma compile_options")}
def present(name): return any(o==name or o.startswith(name+'=') for o in opts)
want = ["ENABLE_FTS5","ENABLE_RTREE","ENABLE_STAT4","ENABLE_MATH_FUNCTIONS","ENABLE_NORMALIZE","ENABLE_COLUMN_METADATA","ENABLE_DBPAGE_VTAB","ENABLE_DBSTAT_VTAB","ENABLE_STMTVTAB","LIKE_DOESNT_MATCH_BLOBS","DEFAULT_MEMSTATUS","THREADSAFE","OMIT_DEPRECATED","ENABLE_NAN_INF"]
missing = [w for w in want if not present(w)]
con.execute("CREATE VIRTUAL TABLE f USING fts5(x);")
con.execute("CREATE VIRTUAL TABLE r USING rtree(id,minX,maxX,minY,maxY);")
con.execute("SELECT sin(0.0), log(10.0);").fetchone()
with tempfile.TemporaryDirectory() as d:
    db = os.path.join(d,"t.db")
    c = sqlite3.connect(db)
    jm = c.execute("PRAGMA journal_mode=wal2;").fetchone()[0]
    c.close()
    wal2_ok = (jm == "wal2")
print("Missing options:", missing)
sys.exit(1 if missing or not wal2_ok else 0)
PY
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-x86_64
          path: wheelhouse/*.whl

  macos-arm64:
    name: macOS arm64 wheels (cp39–cp312)
    needs: prep-sqlite-amalgamation
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: sqlite-wal2-amalgamation
          path: amalgamation
      - name: Clone pysqlite3 and vendor amalgamation (+prepend defines.h)
        run: |
          set -euxo pipefail
          git clone --depth 1 --branch "${PYSQLITE3_VERSION}" https://github.com/coleifer/pysqlite3.git pysqlite3-src
          cp amalgamation/sqlite3.c pysqlite3-src/
          cp amalgamation/sqlite3.h pysqlite3-src/
          cp amalgamation/sqlite3ext.h pysqlite3-src/
          (cat <<'EOF'
          #define SQLITE_ENABLE_JSON1 1
          #define SQLITE_ENABLE_FTS5 1
          #define SQLITE_ENABLE_RTREE 1
          #define SQLITE_ENABLE_STAT4 1
          #define SQLITE_ENABLE_MATH_FUNCTIONS 1
          #define SQLITE_ENABLE_NORMALIZE 1
          #define SQLITE_ENABLE_DESERIALIZE 1
          #define SQLITE_ENABLE_DBPAGE_VTAB 1
          #define SQLITE_ENABLE_DBSTAT_VTAB 1
          #define SQLITE_ENABLE_STMTVTAB 1
          #define SQLITE_ENABLE_COLUMN_METADATA 1
          #define SQLITE_LIKE_DOESNT_MATCH_BLOBS 1
          #define SQLITE_DEFAULT_MEMSTATUS 0
          #define SQLITE_THREADSAFE 2
          #define SQLITE_OMIT_DEPRECATED 1
          #define SQLITE_ENABLE_NAN_INF 1
          EOF
          ) > pysqlite3-src/defines.h
          (printf '#include "defines.h"\n'; cat pysqlite3-src/sqlite3.c) > pysqlite3-src/sqlite3.c.new
          mv pysqlite3-src/sqlite3.c.new pysqlite3-src/sqlite3.c
          head -n 1 pysqlite3-src/sqlite3.c | grep -q 'defines.h'
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: python -m pip install -U pip cibuildwheel==2.*
      - name: Build wheels
        env:
          CIBW_BUILD: "cp39-macosx_* cp310-macosx_* cp311-macosx_* cp312-macosx_*"
          CIBW_ARCHS_MACOS: "arm64"
          CIBW_BEFORE_BUILD: "python -m pip install -U setuptools wheel && cd {package} && python setup.py build_static"
          CIBW_ENVIRONMENT_MACOS: 'MACOSX_DEPLOYMENT_TARGET=11.0 CFLAGS="-O3 -fPIC -DNDEBUG ${{ env.POSIX_SQLITE_DEFINES }}" CPPFLAGS="$CFLAGS"'
          CIBW_BUILD_VERBOSITY: "1"
        run: python -m cibuildwheel pysqlite3-src --output-dir wheelhouse
      - name: Verify compile options + quick probes
        run: |
          set -euxo pipefail
          python -m pip install --no-index --find-links=wheelhouse "pysqlite3==${PYSQLITE3_VERSION}"
          python - <<'PY'
import pysqlite3.dbapi2 as sqlite3, sys, os, tempfile
con = sqlite3.connect(":memory:")
opts = {row[0] for row in con.execute("pragma compile_options")}
def present(name): return any(o==name or o.startswith(name+'=') for o in opts)
want = ["ENABLE_FTS5","ENABLE_RTREE","ENABLE_STAT4","ENABLE_MATH_FUNCTIONS","ENABLE_NORMALIZE","ENABLE_COLUMN_METADATA","ENABLE_DBPAGE_VTAB","ENABLE_DBSTAT_VTAB","ENABLE_STMTVTAB","LIKE_DOESNT_MATCH_BLOBS","DEFAULT_MEMSTATUS","THREADSAFE","OMIT_DEPRECATED","ENABLE_NAN_INF"]
missing = [w for w in want if not present(w)]
con.execute("CREATE VIRTUAL TABLE f USING fts5(x);")
con.execute("CREATE VIRTUAL TABLE r USING rtree(id,minX,maxX,minY,maxY);")
con.execute("SELECT sin(0.0), log(10.0);").fetchone()
with tempfile.TemporaryDirectory() as d:
    db = os.path.join(d,"t.db")
    c = sqlite3.connect(db)
    jm = c.execute("PRAGMA journal_mode=wal2;").fetchone()[0]
    c.close()
    wal2_ok = (jm == "wal2")
print("Missing options:", missing)
sys.exit(1 if missing or not wal2_ok else 0)
PY
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-arm64
          path: wheelhouse/*.whl

  # ---------- Windows ----------
  windows-amd64:
    name: Windows amd64 wheels (cp39–cp312)
    needs: prep-sqlite-amalgamation
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: sqlite-wal2-amalgamation
          path: amalgamation
      - name: Clone pysqlite3 and vendor amalgamation (+prepend defines.h)
        shell: pwsh
        run: |
          git clone --depth 1 --branch $env:PYSQLITE3_VERSION https://github.com/coleifer/pysqlite3.git pysqlite3-src
          Copy-Item amalgamation\sqlite3.c pysqlite3-src\
          Copy-Item amalgamation\sqlite3.h pysqlite3-src\
          Copy-Item amalgamation\sqlite3ext.h pysqlite3-src\
          $defs = @'
          #define SQLITE_ENABLE_JSON1 1
          #define SQLITE_ENABLE_FTS5 1
          #define SQLITE_ENABLE_RTREE 1
          #define SQLITE_ENABLE_STAT4 1
          #define SQLITE_ENABLE_MATH_FUNCTIONS 1
          #define SQLITE_ENABLE_NORMALIZE 1
          #define SQLITE_ENABLE_DESERIALIZE 1
          #define SQLITE_ENABLE_DBPAGE_VTAB 1
          #define SQLITE_ENABLE_DBSTAT_VTAB 1
          #define SQLITE_ENABLE_STMTVTAB 1
          #define SQLITE_ENABLE_COLUMN_METADATA 1
          #define SQLITE_LIKE_DOESNT_MATCH_BLOBS 1
          #define SQLITE_DEFAULT_MEMSTATUS 0
          #define SQLITE_THREADSAFE 2
          #define SQLITE_OMIT_DEPRECATED 1
          #define SQLITE_ENABLE_NAN_INF 1
          '@
          Set-Content -Path "pysqlite3-src\defines.h" -Value $defs
          $p = "pysqlite3-src\sqlite3.c"
          $orig = Get-Content $p -Raw
          '#include "defines.h"' + "`r`n" + $orig | Set-Content $p -NoNewline
          Select-String -Path $p -Pattern 'defines.h' | Out-Null
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: python -m pip install -U pip cibuildwheel==2.*
      - name: Build wheels
        env:
          CIBW_BUILD: "cp39-win_amd64 cp310-win_amd64 cp311-win_amd64 cp312-win_amd64"
          CIBW_ARCHS_WINDOWS: "AMD64"
          CIBW_BEFORE_BUILD_WINDOWS: "python -m pip install -U setuptools wheel && cd {package} && python setup.py build_static"
          # Important: no inner quotes so MSVC picks up /D flags (redundant with defines.h but harmless)
          CIBW_ENVIRONMENT_WINDOWS: CL=/O2 /DNDEBUG /DSQLITE_ENABLE_JSON1 /DSQLITE_ENABLE_FTS5 /DSQLITE_ENABLE_RTREE /DSQLITE_ENABLE_STAT4 /DSQLITE_ENABLE_MATH_FUNCTIONS /DSQLITE_ENABLE_NORMALIZE /DSQLITE_ENABLE_DESERIALIZE /DSQLITE_ENABLE_DBPAGE_VTAB /DSQLITE_ENABLE_DBSTAT_VTAB /DSQLITE_ENABLE_STMTVTAB /DSQLITE_ENABLE_COLUMN_METADATA /DSQLITE_LIKE_DOESNT_MATCH_BLOBS /DSQLITE_DEFAULT_MEMSTATUS=0 /DSQLITE_THREADSAFE=2 /DSQLITE_OMIT_DEPRECATED /DSQLITE_ENABLE_NAN_INF
          CIBW_BUILD_VERBOSITY: "1"
        run: python -m cibuildwheel pysqlite3-src --output-dir wheelhouse
      - name: Verify compile options + quick probes
        shell: pwsh
        run: |
          python -m pip install --no-index --find-links=wheelhouse "pysqlite3==$env:PYSQLITE3_VERSION"
          python - <<'PY'
import pysqlite3.dbapi2 as sqlite3, sys, os, tempfile
con = sqlite3.connect(":memory:")
opts = {row[0] for row in con.execute("pragma compile_options")}
def present(name): return any(o==name or o.startswith(name+'=') for o in opts)
want = ["ENABLE_FTS5","ENABLE_RTREE","ENABLE_STAT4","ENABLE_MATH_FUNCTIONS","ENABLE_NORMALIZE","ENABLE_COLUMN_METADATA","ENABLE_DBPAGE_VTAB","ENABLE_DBSTAT_VTAB","ENABLE_STMTVTAB","LIKE_DOESNT_MATCH_BLOBS","DEFAULT_MEMSTATUS","THREADSAFE","OMIT_DEPRECATED","ENABLE_NAN_INF"]
missing = [w for w in want if not present(w)]
con.execute("CREATE VIRTUAL TABLE f USING fts5(x);")
con.execute("CREATE VIRTUAL TABLE r USING rtree(id,minX,maxX,minY,maxY);")
con.execute("SELECT sin(0.0), log(10.0);").fetchone()
with tempfile.TemporaryDirectory() as d:
    db = os.path.join(d,"t.db")
    c = sqlite3.connect(db)
    jm = c.execute("PRAGMA journal_mode=wal2;").fetchone()[0]
    c.close()
    wal2_ok = (jm == "wal2")
print("Missing options:", missing)
sys.exit(1 if missing or not wal2_ok else 0)
PY
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-amd64
          path: wheelhouse\*.whl

  # ---------- Gather ----------
  gather:
    name: Gather all wheels
    needs:
      - linux-manylinux-x86_64
      - linux-manylinux-aarch64
      - linux-musllinux-x86_64
      - linux-musllinux-aarch64
      - macos-x86_64
      - macos-arm64
      - windows-amd64
    runs-on: ubuntu-latest
    steps:
      - run: sudo apt-get update && sudo apt-get install -y zip
      - uses: actions/download-artifact@v4
        with:
          path: wheelhouse_all
      - run: ls -R wheelhouse_all
      - run: |
          cd wheelhouse_all
          zip -r ../pysqlite3-wal2-wheels.zip .
      - uses: actions/upload-artifact@v4
        with:
          name: pysqlite3-wal2-wheels-all
          path: pysqlite3-wal2-wheels.zip
